name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

env:
  IMAGE: {{ cookiecutter.__container_registry }}/{{ cookiecutter.__target }}

jobs:
  check:
    name: Code Quality
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "{{ cookiecutter.python_version }}"
{% if cookiecutter.include_frontend == "yes" %}
      - uses: actions/setup-node@v4
        with:
          node-version: "{{ cookiecutter.node_version }}"
      - run: corepack enable
{% endif %}
      - run: make backend-install
      - run: make backend-check
{% if cookiecutter.include_frontend == "yes" %}
      - run: make frontend-install
      - run: make frontend-check
{% endif %}

  test:
    name: Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "{{ cookiecutter.python_version }}"
{% if cookiecutter.include_frontend == "yes" %}
      - uses: actions/setup-node@v4
        with:
          node-version: "{{ cookiecutter.node_version }}"
      - run: corepack enable
{% endif %}
      - run: make backend-install
      - run: make backend-test
{% if cookiecutter.include_frontend == "yes" %}
      - run: make frontend-install
      - run: make frontend-test
{% endif %}

  build-image:
    name: Build & Push Image
    needs: [check, test]
    if: github.event_name != 'pull_request'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    steps:
      - uses: actions/checkout@v4
      - uses: docker/setup-qemu-action@v3
      - uses: docker/setup-buildx-action@v3
      - uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: {% raw %}${{ github.actor }}{% endraw %}
          password: {% raw %}${{ secrets.GITHUB_TOKEN }}{% endraw %}
      - uses: docker/build-push-action@v6
        with:
          context: .
          platforms: linux/amd64,linux/arm64
          push: true
          tags: |
            {% raw %}${{ env.IMAGE }}:${{ github.sha }}{% endraw %}
            {% raw %}${{ env.IMAGE }}:latest{% endraw %}
